model DiscussionThread {
  id         String   @id @default(cuid())
  title      String
  authorId   String // Admin or Student ID
  authorName String
  content    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  replies DiscussionReply[]

  @@index([authorId])
  @@map("discussion_threads")
}

model DiscussionReply {
  id         String   @id @default(cuid())
  threadId   String
  authorId   String // Admin or Student ID
  authorName String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  thread DiscussionThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([authorId])
  @@map("discussion_replies")
}

// ===== CURRICULUM MODELS =====

enum ActivityType {
  READING
  QUIZ
  CODING_LAB
  DISCUSSION
  NETWORK_LAB
  PROJECT
}

model Course {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?
  level       String   @default("XI") // XI, XII, etc.
  subject     String   @default("Informatika")
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  modules Module[]

  @@index([level])
  @@index([subject])
  @@index([isActive])
  @@map("courses")
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  slug        String   @unique
  description String?
  chapter     String   // Bab 1, Bab 2, etc.
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]
  competencyMaps CompetencyMap[]

  @@index([courseId])
  @@index([chapter])
  @@index([isActive])
  @@map("modules")
}

model Lesson {
  id          String   @id @default(cuid())
  moduleId    String
  title       String
  slug        String   @unique
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module   Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  activities Activity[]

  @@index([moduleId])
  @@index([isActive])
  @@map("lessons")
}

model Activity {
  id          String      @id @default(cuid())
  lessonId    String
  title       String
  type        ActivityType
  content     String?     // For reading content
  quizId      String?     // Link to Quiz if type is QUIZ
  codingTaskId String?    // Link to CodingLabTask if type is CODING_LAB
  assignmentId String?    // Link to Assignment if type is PROJECT
  order       Int         @default(0)
  isActive    Boolean     @default(true)
  timeLimit   Int?        // In minutes
  points      Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  quiz   Quiz?  @relation(fields: [quizId], references: [id])
  competencyMaps CompetencyMap[]
  grades Grade[]

  @@index([lessonId])
  @@index([type])
  @@index([isActive])
  @@map("activities")
}

model Competency {
  id          String   @id @default(cuid())
  code        String   @unique
  description String
  level       String   @default("XI")
  subject     String   @default("Informatika")
  category    String   // KD, Capaian, etc.
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  mappings CompetencyMap[]

  @@index([level])
  @@index([subject])
  @@index([category])
  @@map("competencies")
}

model CompetencyMap {
  id           String   @id @default(cuid())
  competencyId String
  activityId   String?
  quizId       String?
  moduleId     String?
  weight       Float    @default(1.0)
  createdAt    DateTime @default(now())

  // Relations
  competency Competency @relation(fields: [competencyId], references: [id], onDelete: Cascade)
  activity    Activity? @relation(fields: [activityId], references: [id])
  quiz        Quiz?     @relation(fields: [quizId], references: [id])
  module      Module?   @relation(fields: [moduleId], references: [id])

  @@index([competencyId])
  @@index([activityId])
  @@index([quizId])
  @@index([moduleId])
  @@map("competency_maps")
}

model Grade {
  id            String   @id @default(cuid())
  studentId     String
  activityId    String?
  submissionId  String?
  quizResponseId String?
  score         Float
  maxScore      Float    @default(100)
  feedback      String?
  gradedBy      String   // Admin ID
  gradedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  activity     Activity?     @relation(fields: [activityId], references: [id])
  submission   Submission?   @relation(fields: [submissionId], references: [id])
  quizResponse QuizResponse? @relation(fields: [quizResponseId], references: [id])
  grader       Admin         @relation(fields: [gradedBy], references: [id])

  @@index([studentId])
  @@index([activityId])
  @@index([submissionId])
  @@index([quizResponseId])
  @@map("grades")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("ADMIN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  webLabAssignments   WebLabAssignment[]
  webLabEvaluations   WebLabEvaluation[]
  codingEvaluations   CodingEvaluation[]
  quizzes             Quiz[]
  hostedQuizSessions  QuizSession[]
  quizResponsesGraded QuizResponse[]     @relation("QuizResponseGrader")
  quizSessionEvents   QuizSessionEvent[]
  grades              Grade[]

  @@map("admins")
}

model Contact {
  id         String    @id @default(cuid())
  name       String
  email      String
  phone      String?
  subject    String?
  message    String
  status     String    @default("unread") // unread, read, replied
  adminReply String?
  repliedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("contacts")
}

model Registration {
  id        String   @id @default(cuid())
  fullName  String
  email     String
  phone     String
  school    String?
  address   String?
  program   String   @default("GEMA")
  status    String   @default("pending") // pending, approved, rejected
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("registrations")
}

enum AnnouncementCategory {
  KELAS
  EVENT
  TUGAS
  NILAI
  SISTEM
}

model Announcement {
  id             String                @id @default(cuid())
  title          String
  excerpt        String?               // Short description for card
  content        String                // Full content
  category       AnnouncementCategory  @default(SISTEM)
  type           String                @default("info") // info, warning, success, error (for backward compatibility)
  isImportant    Boolean               @default(false)
  isActive       Boolean               @default(true)
  showOnHomepage Boolean               @default(false)
  deadline       DateTime?             // For tasks/events
  link           String?               // External link
  views          Int                   @default(0)
  publishDate    DateTime              @default(now())
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@index([category])
  @@index([isImportant])
  @@index([isActive])
  @@index([publishDate])
  @@map("announcements")
}

model Settings {
  id    String @id @default(cuid())
  key   String @unique
  value String

  @@map("settings")
}

model Event {
  id             String   @id @default(cuid())
  title          String
  description    String?
  date           DateTime
  location       String?
  capacity       Int?
  registered     Int      @default(0)
  isActive       Boolean  @default(true)
  showOnHomepage Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("events")
}

model Gallery {
  id             String   @id @default(cuid())
  title          String
  description    String?
  imageUrl       String
  category       String   @default("general")
  isActive       Boolean  @default(true)
  showOnHomepage Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("galleries")
}

model ChatMessage {
  id          String   @id @default(cuid())
  message     String
  senderName  String
  senderEmail String
  senderType  String   @default("user") // user, admin
  status      String   @default("sent") // sent, delivered, read
  sessionId   String? // Group messages by session
  replyTo     String? // Reference to message being replied to
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}

model ChatSession {
  id          String   @id @default(cuid())
  userEmail   String
  userName    String
  status      String   @default("active") // active, closed, waiting
  assignedTo  String? // Admin user ID
  lastMessage DateTime @default(now())
  priority    String   @default("normal") // high, normal, low
  tags        String? // JSON array of tags
  notes       String? // Admin notes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([assignedTo])
  @@index([lastMessage])
  @@map("chat_sessions")
}

model Assignment {
  id               String   @id @default(cuid())
  title            String
  description      String
  subject          String
  dueDate          DateTime
  maxSubmissions   Int      @default(30)
  status           String   @default("active") // active, closed, upcoming
  instructions     String? // JSON array of instructions
  allowedFileTypes String   @default("pdf,doc,docx,ppt,pptx") // Document and presentation types
  maxFileSize      Int      @default(10485760) // 10MB in bytes
  createdBy        String // Admin ID
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  submissions Submission[]

  @@index([status])
  @@index([dueDate])
  @@map("assignments")
}

model Submission {
  id               String    @id @default(cuid())
  assignmentId     String
  studentId        String // Reference to Student model
  fileName         String
  originalFileName String
  filePath         String // Cloud storage URL or local path
  fileSize         Int
  mimeType         String
  documentType     String? // pdf, doc, docx for document submissions
  previewUrl       String? // URL for document preview/thumbnail
  submittedAt      DateTime  @default(now())
  status           String    @default("submitted") // submitted, late, reviewed, graded
  grade            Float? // Grade if applicable
  feedback         String? // Teacher feedback
  reviewedAt       DateTime?
  reviewedBy       String? // Admin ID
  isLate           Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grades     Grade[]

  @@index([assignmentId])
  @@index([studentId])
  @@index([submittedAt])
  @@map("submissions")
}

enum CodingLabSubmissionStatus {
  DRAFT
  SUBMITTED
  RETURNED
  GRADED
}

enum CodingLabArtifactType {
  EDITOR
  UPLOAD
}

enum CodingLabRubricCriterion {
  HTML_STRUCTURE
  CSS_RESPONSIVE
  JS_INTERACTIVITY
  CODE_QUALITY
  CREATIVITY_BRIEF
}

model CodingLabTask {
  id           String   @id @default(cuid())
  title        String
  description  String
  classLevel   String
  tags         String?
  instructions String?
  project      Json? // { title, description, rubric }
  files        Json? // { path, language, content }[]
  previewMode  String? // e.g., "iframe", "image"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  submissions CodingLabSubmission[]

  @@unique([title, classLevel])
  @@map("coding_lab_tasks")
}

model CodingLabSubmission {
  id               String                    @id @default(cuid())
  taskId           String
  studentId        String
  title            String
  summary          String?
  classLevel       String
  tags             String?
  status           CodingLabSubmissionStatus @default(DRAFT)
  lastVersionId    String?                   @unique
  grade            Int?
  reviewerId       String?
  reviewerNote     String?
  submittedAt      DateTime?
  returnedAt       DateTime?
  draftHtml        String?
  draftCss         String?
  draftJs          String?
  draftArtifact    CodingLabArtifactType     @default(EDITOR)
  draftArchivePath String?
  draftArchiveSize Int?
  draftMetadata    String?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  task        CodingLabTask         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  student     Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lastVersion CodingLabVersion?     @relation("SubmissionLastVersion", fields: [lastVersionId], references: [id])
  versions    CodingLabVersion[]    @relation("SubmissionVersions")
  evaluations CodingLabEvaluation[]

  @@unique([studentId, taskId])
  @@index([taskId])
  @@index([studentId])
  @@index([status])
  @@map("coding_lab_submissions")
}

model CodingLabVersion {
  id           String                @id @default(cuid())
  submissionId String
  title        String
  summary      String?
  classLevel   String
  tags         String?
  html         String?
  css          String?
  js           String?
  artifactType CodingLabArtifactType @default(EDITOR)
  archivePath  String?
  archiveSize  Int?
  metadata     String?
  createdAt    DateTime              @default(now())
  lockedAt     DateTime

  submission          CodingLabSubmission  @relation("SubmissionVersions", fields: [submissionId], references: [id], onDelete: Cascade)
  latestForSubmission CodingLabSubmission? @relation("SubmissionLastVersion")
  evaluation          CodingLabEvaluation?

  @@index([submissionId])
  @@map("coding_lab_versions")
}

model CodingLabEvaluation {
  id           String                    @id @default(cuid())
  submissionId String
  versionId    String                    @unique
  reviewerId   String
  overallScore Int
  overallNote  String?
  status       CodingLabSubmissionStatus
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt

  submission   CodingLabSubmission    @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  version      CodingLabVersion       @relation(fields: [versionId], references: [id], onDelete: Cascade)
  rubricScores CodingLabRubricScore[]

  @@index([submissionId])
  @@map("coding_lab_evaluations")
}

model CodingLabRubricScore {
  id           String                   @id @default(cuid())
  evaluationId String
  criterion    CodingLabRubricCriterion
  score        Int
  maxScore     Int
  comment      String?

  evaluation CodingLabEvaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@unique([evaluationId, criterion])
  @@index([evaluationId])
  @@map("coding_lab_rubric_scores")
}

model ClassroomProjectChecklist {
  id               String   @id @default(cuid())
  title            String
  slug             String   @unique
  goal             String
  skills           Json
  basicTargets     Json
  advancedTargets  Json
  reflectionPrompt String?
  order            Int      @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("classroom_project_checklists")
}

model Classroom {
  id          String   @id @default(cuid())
  title       String
  slug        String?  @unique
  description String?
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([teacherId])
  @@map("classrooms")
}

model Student {
  id           String    @id @default(cuid())
  studentId    String    @unique // NIS atau nomor identitas siswa
  email        String    @unique
  password     String
  fullName     String
  class        String? // Kelas siswa (X-A, XI-B, XII-C, dll)
  phone        String?
  address      String?
  parentName   String? // Nama orang tua/wali
  parentPhone  String? // Telepon orang tua/wali
  extracurricularInterests Json?
  status       String    @default("active") // active, inactive, suspended
  isVerified   Boolean   @default(false) // Email verification
  profileImage String? // URL foto profil
  joinedAt     DateTime  @default(now())
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  submissions         Submission[]
  CodingLabSubmission CodingLabSubmission[]
  ArticleFeedback     ArticleFeedback[]
  webLabSubmissions   WebLabSubmission[]
  codingSubmissions   CodingSubmission[]
  pythonSubmissions   PythonSubmission[]    @relation("PythonSubmissions")
  quizParticipations  QuizParticipant[]
  grades              Grade[]

  @@index([studentId])
  @@index([status])
  @@index([class])
  @@map("students")
}

// ===== QUIZ MODELS =====

enum QuizQuestionType {
  MULTIPLE_CHOICE
  MULTI_SELECT
  TRUE_FALSE
  SHORT_ANSWER
  NUMERIC
  SCALE
}

enum QuizSessionMode {
  LIVE
  HOMEWORK
}

enum QuizSessionStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum QuizSessionEventType {
  CREATED
  HOST_JOINED
  STARTED
  QUESTION_ADVANCED
  QUESTION_REWOUND
  PAUSED
  RESUMED
  FINISHED
  SCORE_ADJUSTED
  MANUAL_GRADE
}

model Quiz {
  id              String    @id @default(cuid())
  title           String
  description     String?
  slug            String?   @unique
  tags            Json?
  isPublic        Boolean   @default(false)
  timePerQuestion Int?
  defaultPoints   Int       @default(1)
  createdBy       String
  publishedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  createdByAdmin Admin          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  questions      QuizQuestion[]
  sessions       QuizSession[]
  activities     Activity[]
  competencyMaps CompetencyMap[]

  @@index([createdBy])
  @@index([isPublic])
  @@map("quizzes")
}

model QuizQuestion {
  id               String           @id @default(cuid())
  quizId           String
  order            Int
  type             QuizQuestionType
  prompt           String
  richContent      Json?
  mediaUrl         String?
  options          Json?
  correctAnswers   Json?
  competencyTag    String?
  explanation      String?
  difficulty       String?
  points           Int              @default(1)
  timeLimitSeconds Int?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  quiz      Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  responses QuizResponse[]
  currentIn QuizSession[]  @relation("SessionCurrentQuestion")

  @@unique([quizId, order])
  @@index([quizId])
  @@map("quiz_questions")
}

model QuizSession {
  id                       String            @id @default(cuid())
  quizId                   String
  hostId                   String
  code                     String            @unique
  title                    String?
  description              String?
  mode                     QuizSessionMode
  status                   QuizSessionStatus @default(DRAFT)
  scheduledStart           DateTime?
  scheduledEnd             DateTime?
  startedAt                DateTime?
  finishedAt               DateTime?
  currentQuestionId        String?
  currentQuestionStartedAt DateTime?
  homeworkWindowStart      DateTime?
  homeworkWindowEnd        DateTime?
  maxAttemptsPerQuestion   Int?
  metadata                 Json?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt

  quiz            Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)
  host            Admin              @relation(fields: [hostId], references: [id])
  currentQuestion QuizQuestion?      @relation("SessionCurrentQuestion", fields: [currentQuestionId], references: [id])
  participants    QuizParticipant[]
  responses       QuizResponse[]
  events          QuizSessionEvent[]

  @@index([quizId])
  @@index([hostId])
  @@index([status])
  @@index([mode])
  @@index([scheduledStart])
  @@index([scheduledEnd])
  @@map("quiz_sessions")
}

model QuizParticipant {
  id            String    @id @default(cuid())
  sessionId     String
  studentId     String?
  displayName   String
  avatarColor   String?
  joinedAt      DateTime  @default(now())
  lastSeenAt    DateTime?
  score         Float     @default(0)
  accuracy      Float?
  responseCount Int       @default(0)
  isKicked      Boolean   @default(false)
  metadata      Json?

  session   QuizSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student   Student?       @relation(fields: [studentId], references: [id], onDelete: SetNull)
  responses QuizResponse[]

  @@unique([sessionId, displayName])
  @@index([sessionId])
  @@index([studentId])
  @@index([score])
  @@map("quiz_participants")
}

model QuizResponse {
  id            String    @id @default(cuid())
  sessionId     String
  participantId String
  questionId    String
  answer        Json?
  score         Float     @default(0)
  maxScore      Float     @default(0)
  isCorrect     Boolean?
  attempt       Int       @default(1)
  submittedAt   DateTime  @default(now())
  gradedAt      DateTime?
  gradedBy      String?
  latencyMs     Int?
  feedback      String?
  metadata      Json?

  session     QuizSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participant QuizParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  question    QuizQuestion    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  grader      Admin?          @relation("QuizResponseGrader", fields: [gradedBy], references: [id], onDelete: SetNull)
  grades      Grade[]

  @@unique([participantId, questionId, sessionId])
  @@index([sessionId])
  @@index([questionId])
  @@index([participantId])
  @@map("quiz_responses")
}

model QuizSessionEvent {
  id        String               @id @default(cuid())
  sessionId String
  type      QuizSessionEventType
  actorId   String?
  actorName String?
  payload   Json?
  createdAt DateTime             @default(now())

  session QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actor   Admin?      @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
  @@map("quiz_session_events")
}

model Article {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  excerpt       String? // Short description
  content       String // Full article content (HTML/Markdown)
  category      String // tutorial, news, technology, programming, etc.
  tags          String? // JSON array of tags
  author        String // Author name
  authorId      String // Admin ID
  status        String    @default("draft") // draft, published, archived
  featured      Boolean   @default(false)
  imageUrl      String? // Featured image
  readTime      Int? // Estimated read time in minutes
  views         Int       @default(0)
  averageRating Float? // Average user rating
  totalFeedback Int       @default(0) // Total feedback count
  publishedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  feedback ArticleFeedback[]

  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@index([featured])
  @@map("articles")
}

model ArticleFeedback {
  id        String   @id @default(cuid())
  articleId String
  studentId String? // Optional: for authenticated students
  rating    Int // 1-5 stars
  comment   String? // Optional feedback comment
  challenge String? // What was most challenging
  checklist Json? // Testing checklist results
  userAgent String? // Browser information
  ipAddress String? // For spam prevention
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  // Relations
  article Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  student Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@index([articleId])
  @@index([studentId])
  @@index([rating])
  @@index([timestamp])
  @@map("article_feedback")
}

// ===== WEB LAB MODELS =====

enum WebLabDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum WebLabStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum WebLabSubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  RETURNED
}

enum WebLabEvaluationStatus {
  PENDING
  COMPLETED
  NEEDS_REVISION
}

model WebLabAssignment {
  id           String           @id @default(cuid())
  title        String
  description  String
  difficulty   WebLabDifficulty @default(BEGINNER)
  classLevel   String? // Target class level (XI-A, XI-B, etc.)
  instructions String // Detailed instructions for the assignment
  starterHtml  String? // Starter HTML code
  starterCss   String? // Starter CSS code
  starterJs    String? // Starter JavaScript code
  template     String? // e.g., "html-dasar", "landing-sederhana", "todo-js"
  requirements Json? // JSON array of requirements/checklist
  hints        Json? // JSON array of hints
  solutionHtml String? // Solution HTML (for admin reference)
  solutionCss  String? // Solution CSS (for admin reference)
  solutionJs   String? // Solution JavaScript (for admin reference)
  points       Int              @default(100)
  timeLimit    Int? // Time limit in minutes
  status       WebLabStatus     @default(DRAFT)
  createdBy    String // Admin ID
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  submissions WebLabSubmission[]
  admin       Admin              @relation(fields: [createdBy], references: [id])

  @@index([status])
  @@index([difficulty])
  @@index([classLevel])
  @@map("web_lab_assignments")
}

model WebLabSubmission {
  id           String                 @id @default(cuid())
  assignmentId String
  studentId    String
  html         String?
  css          String?
  js           String?
  status       WebLabSubmissionStatus @default(DRAFT)
  submittedAt  DateTime?
  gradedAt     DateTime?
  score        Int?
  feedback     String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  // Relations
  assignment WebLabAssignment          @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    Student                   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  evaluation WebLabEvaluation?
  versions   WebLabSubmissionVersion[]

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
  @@map("web_lab_submissions")
}

model WebLabSubmissionVersion {
  id           String   @id @default(cuid())
  submissionId String
  html         String?
  css          String?
  js           String?
  createdAt    DateTime @default(now())

  submission WebLabSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("web_lab_submission_versions")
}

model WebLabEvaluation {
  id           String   @id @default(cuid())
  submissionId String   @unique
  evaluatedBy  String // Admin ID
  score        Int
  feedback     String?
  checklist    Json? // JSON object with requirement evaluations
  evaluatedAt  DateTime @default(now())

  // Relations
  submission WebLabSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  admin      Admin            @relation(fields: [evaluatedBy], references: [id])

  @@index([evaluatedBy])
  @@map("web_lab_evaluations")
}

// ===== CODING LAB MODELS =====

enum CodingDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CodingSubmissionStatus {
  DRAFT
  SUBMITTED
  EVALUATING
  APPROVED
  REJECTED
}

model CodingLab {
  id          String           @id @default(cuid())
  title       String
  description String?
  difficulty  CodingDifficulty @default(BEGINNER)
  language    String // Programming language (JavaScript, Python, Java, etc.)
  points      Int              @default(100)
  duration    Int // Duration in minutes
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  exercises CodingExercise[]

  @@index([difficulty])
  @@index([language])
  @@index([isActive])
  @@map("coding_labs")
}

model CodingExercise {
  id           String           @id @default(cuid())
  labId        String
  title        String
  description  String
  difficulty   CodingDifficulty @default(BEGINNER)
  points       Int              @default(10)
  timeLimit    Int // Time limit in seconds
  memoryLimit  Int // Memory limit in MB
  instructions String
  starterCode  String
  solutionCode String?
  hints        String? // JSON array of hints
  tags         String? // JSON array of tags
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  lab         CodingLab          @relation(fields: [labId], references: [id], onDelete: Cascade)
  testCases   CodingTestCase[]
  submissions CodingSubmission[]

  @@index([labId])
  @@index([difficulty])
  @@index([isActive])
  @@map("coding_exercises")
}

model CodingTestCase {
  id             String   @id @default(cuid())
  exerciseId     String
  input          String
  expectedOutput String
  isHidden       Boolean  @default(false)
  explanation    String?
  createdAt      DateTime @default(now())

  // Relations
  exercise CodingExercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([exerciseId])
  @@map("coding_test_cases")
}

model CodingSubmission {
  id            String                 @id @default(cuid())
  exerciseId    String
  studentId     String
  code          String
  status        CodingSubmissionStatus @default(DRAFT)
  score         Int?
  executionTime Int? // Execution time in milliseconds
  memoryUsed    Int? // Memory used in KB
  testResults   Json? // JSON array of test results
  submittedAt   DateTime?
  attempts      Int                    @default(0)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  // Relations
  exercise   CodingExercise    @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  student    Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  evaluation CodingEvaluation?

  @@unique([exerciseId, studentId]) // One submission per student per exercise
  @@index([exerciseId])
  @@index([studentId])
  @@index([status])
  @@map("coding_submissions")
}

model CodingEvaluation {
  id           String   @id @default(cuid())
  submissionId String   @unique
  evaluatedBy  String // Admin ID
  overallScore Int
  feedback     String?
  evaluatedAt  DateTime @default(now())

  // Relations
  submission CodingSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  admin      Admin            @relation(fields: [evaluatedBy], references: [id])

  @@index([evaluatedBy])
  @@map("coding_evaluations")
}

// ===== PYTHON CODING LAB MODELS (Judge0 Integration) =====

enum PythonTaskDifficulty {
  EASY
  MEDIUM
  HARD
}

enum PythonSubmissionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RUNTIME_ERROR
  COMPILATION_ERROR
  TIME_LIMIT_EXCEEDED
}

model PythonCodingTask {
  id           String               @id @default(cuid())
  title        String
  slug         String               @unique
  description  String
  difficulty   PythonTaskDifficulty @default(EASY)
  category     String               @default("general") // general, algorithm, data-structure, etc.
  tags         String? // JSON array of tags
  starterCode  String               @default("# Write your Python code here\n\ndef solution():\n    pass\n\n# Test your solution\nif __name__ == \"__main__\":\n    print(solution())")
  solutionCode String? // Solution code for reference
  hints        Json? // Array of hints
  timeLimit    Int                  @default(5) // seconds
  memoryLimit  Int                  @default(128) // MB
  points       Int                  @default(100)
  order        Int                  @default(0)
  isActive     Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  // Relations
  testCases   PythonTestCase[]
  submissions PythonSubmission[]

  @@index([difficulty])
  @@index([category])
  @@index([isActive])
  @@index([order])
  @@map("python_coding_tasks")
}

model PythonTestCase {
  id             String   @id @default(cuid())
  taskId         String
  name           String // Test case name/description
  input          String // Input for the test
  expectedOutput String // Expected output
  isHidden       Boolean  @default(false) // Hidden test cases for validation
  points         Int      @default(10)
  order          Int      @default(0)
  createdAt      DateTime @default(now())

  // Relations
  task PythonCodingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([order])
  @@map("python_test_cases")
}

model PythonSubmission {
  id            String                 @id @default(cuid())
  taskId        String
  studentId     String
  code          String
  language      String                 @default("python") // python, python3
  status        PythonSubmissionStatus @default(PENDING)
  judge0Token   String? // Judge0 submission token
  stdout        String? // Program output
  stderr        String? // Error output
  compileOutput String? // Compilation output
  message       String? // Judge0 status message
  time          Float? // Execution time in seconds
  memory        Int? // Memory used in KB
  score         Int                    @default(0) // Score based on passed test cases
  totalTests    Int                    @default(0)
  passedTests   Int                    @default(0)
  testResults   Json? // Detailed test results
  submittedAt   DateTime               @default(now())
  completedAt   DateTime?
  attempts      Int                    @default(1)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  // Relations
  task    PythonCodingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  student Student          @relation("PythonSubmissions", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([studentId])
  @@index([status])
  @@index([submittedAt])
  @@map("python_submissions")
}
